
#include "cp3_tensor_test.hpp"

#include <vmmlib/cp3_tensor.hpp>
#include <vmmlib/t3_hopm.hpp>

#include <sstream>

namespace vmml
{

	bool
	cp3_tensor_test::run()
	{
		bool ok = false;

		typedef tensor3< 4, 4, 4, float > t3_type;
		typedef cp3_tensor< 3, 4, 4, 4, float, float > cp3_dec_type;
		typedef t3_hopm< 3, 4, 4, 4, float > t3_hopm_type;

		t3_type t3_cp_input;
		float data_in_cp[] = {
		/*	0.3780, 0.3150, 0.3386, 0.2047, 0.2913, 0.3071, 0.2835, 0.1024, 0.2362, 0.2835, 0.2677, 0.1024, 0.3543, 1.1181, 1.5354, 0.3858,
			0.2520, 0.2283, 0.3228, 0.2835, 0.2677, 0.2598, 0.2992, 0.2126, 0.2441, 0.2205, 0.2441, 0.2913, 0.9213, 0.6457, 0.4331, 0.1890,
			0.4409, 0.4409, 0.5591, 0.5039, 0.2362, 0.4409, 0.5984, 0.6142, 0.2520, 0.2835, 0.3465, 0.3543, 0.5748, 0.2835, 0.2992, 0.2835,
			0.3386, 0.3150, 0.4488, 0.4173, 0.2756, 0.3150, 0.3465, 0.3386, 0.2835, 0.2677, 0.2362, 0.2913, 0.2598, 0.2520, 0.2756, 0.3071 */

			0.8147, 0.6324, 0.9575, 0.9572,
			0.9058, 0.0975, 0.9649, 0.4854,
			0.1270, 0.2785, 0.1576, 0.8003,
			0.9134, 0.5469, 0.9706, 0.1419,

			0.4218, 0.6557, 0.6787, 0.6555,
			0.9157, 0.0357, 0.7577, 0.1712,
			0.7922, 0.8491, 0.7431, 0.7060,
			0.9595, 0.9340, 0.3922, 0.0318,
			0.2769, 0.6948, 0.4387, 0.1869,
			0.0462, 0.3171, 0.3816, 0.4898,
			0.0971, 0.9502, 0.7655, 0.4456,
			0.8235, 0.0344, 0.7952, 0.6463,
			0.7094, 0.6551, 0.9597, 0.7513,
			0.7547, 0.1626, 0.3404, 0.2551,
			0.2760, 0.1190, 0.5853, 0.5060,
			0.6797, 0.4984, 0.2238, 0.6991

		};
		t3_cp_input.set(data_in_cp, data_in_cp + 64);

		cp3_dec_type cp3_dec;
		cp3_dec.cp_als( t3_cp_input, t3_hopm_type::init_hosvd(), 20 );

		t3_type t3_cp_reco;
		cp3_dec.reconstruct( t3_cp_reco );

		t3_type t3_cp_reco_check;
		float data_out_cp[] = {

                0.6516,    0.5677,    0.7854,    0.7902,
                1.0803,    0.0669,    0.8750,    0.3177,
                0.2160,    0.5307,    0.4704,    0.7794,
                1.0214,    0.6457,    0.8461,    0.1598,
                0.7379,    0.5676,    0.8474,    0.7937,
                0.8701,    0.1619,    0.7425,    0.3334,
                0.4384,    0.4797,    0.6185,    0.7704,
                0.7129,    0.7575,    0.6566,    0.2069,
                0.3765,    0.8082,    0.5127,    0.4715,
                0.1458,    0.3739,    0.2438,    0.2985,
                0.2551,    0.8077,    0.3814,    0.3342,
                0.8127,   -0.0088,    0.7963,    0.6755,
                0.6326,    0.5585,    0.7263,    0.6553,
                0.5555,    0.2275,    0.5171,    0.3007,
                0.4548,    0.4744,    0.5754,    0.6069,
                0.5309,    0.5830,    0.5385,    0.2972,
		};
		t3_cp_reco_check.set(data_out_cp, data_out_cp + 64);

		ok = t3_cp_reco.equals( t3_cp_reco_check, 0.0001 );

		log( "cp3 tensor reconstruction ", ok  );

		return ok;
	}


} // namespace vmml

